networks:
    trubanb-network:
        driver: bridge

services:
    # ============================================================================
    # KONG API GATEWAY
    # ============================================================================

    kong:
        image: kong:3.4
        restart: always
        environment:
            KONG_DATABASE: "off"
            KONG_PROXY_ACCESS_LOG: /dev/stdout
            KONG_ADMIN_ACCESS_LOG: /dev/stdout
            KONG_PROXY_ERROR_LOG: /dev/stderr
            KONG_ADMIN_ERROR_LOG: /dev/stderr
            KONG_ADMIN_LISTEN: "0.0.0.0:8001"
            KONG_PROXY_LISTEN: "0.0.0.0:8000, 0.0.0.0:8443 ssl"
            KONG_DECLARATIVE_CONFIG: /kong/kong.yaml
        ports:
            - "${KONG_PROXY_PORT:-8000}:8000"      # Proxy HTTP
            - "${KONG_PROXY_SSL_PORT:-8443}:8443"  # Proxy HTTPS
            - "${KONG_ADMIN_PORT:-8001}:8001"      # Admin API HTTP
        volumes:
            - ./kong/kong.yaml:/kong/kong.yaml:ro
        healthcheck:
            test: ["CMD", "kong", "health"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network
        depends_on:
            - trubanb-user-service
            - trubanb-accommodation-service
            - trubanb-reservation-service
            - trubanb-rating-service
            - trubanb-notification-service

    # ============================================================================
    # USER SERVICE
    # ============================================================================

    # PostgreSQL for user-service
    postgresql-user:
        image: postgres:16-alpine
        restart: always
        environment:
            POSTGRES_DB: userdb
            POSTGRES_USER: userservice
            POSTGRES_PASSWORD: ${POSTGRES_USER_PASSWORD:-userpass123}
        ports:
            - "5432:5432"
        volumes:
            - postgres-user-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U userservice -d userdb"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network

    trubanb-user-service:
        restart: always
        build:
            context: ${USER_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${USER_SERVICE_PORT}:3000"
        depends_on:
            postgresql-user:
                condition: service_healthy
            jaeger:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
        environment:
            DB_HOST: postgresql-user
            DB_PORT: 5432
            DB_NAME: userdb
            DB_USER: userservice
            DB_PASSWORD: ${POSTGRES_USER_PASSWORD:-userpass123}
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: user-service
            JWT_SECRET: ${JWT_SECRET:-dev-jwt-secret-change-in-production}
            NODE_ENV: ${NODE_ENV:-development}
            PORT: 3000
            CORS_ORIGIN: ${CORS_ORIGIN:-*}
            RESERVATION_GRPC_URL: trubanb-reservation-service:50052
            RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672
        networks:
            - trubanb-network

    # ============================================================================
    # ACCOMMODATION SERVICE
    # ============================================================================

    # PostgreSQL for accommodation-service
    postgresql-accommodation:
        image: postgres:16-alpine
        restart: always
        environment:
            POSTGRES_DB: accommodationdb
            POSTGRES_USER: accommodationservice
            POSTGRES_PASSWORD: ${POSTGRES_ACCOMMODATION_PASSWORD:-accommodationpass123}
        ports:
            - "5433:5432"
        volumes:
            - postgres-accommodation-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U accommodationservice -d accommodationdb"]
            interval: 10s
            timeout: 5s
            
            retries: 5
        networks:
            - trubanb-network

    # MinIO for accommodation-service (photo storage)
    minio:
        image: minio/minio:latest
        restart: always
        environment:
            MINIO_ROOT_USER: ${MINIO_ROOT_USER:-minioadmin}
            MINIO_ROOT_PASSWORD: ${MINIO_ROOT_PASSWORD:-minioadmin123}
        ports:
            - "9000:9000"      # API
            - "9001:9001"      # Console UI
        volumes:
            - minio-data:/data
        command: server /data --console-address ":9001"
        healthcheck:
            test: ["CMD", "mc", "ready", "local"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network

    # RabbitMQ (message broker)
    rabbitmq:
        image: rabbitmq:management
        restart: always
        ports:
            - "5672:5672"   # AMQP protocol
            - "15672:15672" # Management UI
        environment:
            RABBITMQ_DEFAULT_USER: ${RABBITMQ_USER:-guest}
            RABBITMQ_DEFAULT_PASS: ${RABBITMQ_PASSWORD:-guest}
        volumes:
            - rabbitmq-data:/var/lib/rabbitmq
        healthcheck:
            test: ["CMD", "rabbitmqctl", "status"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network
            
    trubanb-accommodation-service:
        restart: always
        build:
            context: ${ACCOMMODATION_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${ACCOMMODATION_SERVICE_PORT}:3000"
            - "${ACCOMMODATION_GRPC_PORT:-50051}:50051"
        depends_on:
            postgresql-accommodation:
                condition: service_healthy
            minio:
                condition: service_healthy
            jaeger:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
        environment:
            DB_HOST: postgresql-accommodation
            DB_PORT: 5432
            DB_NAME: accommodationdb
            DB_USER: accommodationservice
            DB_PASSWORD: ${POSTGRES_ACCOMMODATION_PASSWORD:-accommodationpass123}
            MINIO_ENDPOINT: minio
            MINIO_PORT: 9000
            MINIO_USE_SSL: false
            MINIO_ACCESS_KEY: ${MINIO_ROOT_USER:-minioadmin}
            MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD:-minioadmin123}
            MINIO_BUCKET: accommodations
            STORAGE_PUBLIC_URL: http://localhost:9000/accommodations
            GRPC_PORT: 50051
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: accommodation-service
            NODE_ENV: ${NODE_ENV:-development}
            PORT: 3000
            RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672
            CORS_ORIGIN: ${CORS_ORIGIN:-*}
        networks:
            - trubanb-network

    # ============================================================================
    # RESERVATION SERVICE
    # ============================================================================

    # PostgreSQL for reservation-service
    postgresql-reservation:
        image: postgres:16-alpine
        restart: always
        environment:
            POSTGRES_DB: reservationdb
            POSTGRES_USER: reservationservice
            POSTGRES_PASSWORD: ${POSTGRES_RESERVATION_PASSWORD:-reservationpass123}
        ports:
            - "5434:5432"
        volumes:
            - postgres-reservation-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U reservationservice -d reservationdb"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network

    trubanb-reservation-service:
        restart: always
        build:
            context: ${RESERVATION_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${RESERVATION_SERVICE_PORT}:3000"
            - "${RESERVATION_GRPC_PORT:-50052}:50052"
        depends_on:
            postgresql-reservation:
                condition: service_healthy
            trubanb-accommodation-service:
                condition: service_started
            jaeger:
                condition: service_healthy
            rabbitmq:
                condition: service_healthy
        environment:
            DB_HOST: postgresql-reservation
            DB_PORT: 5432
            DB_NAME: reservationdb
            DB_USER: reservationservice
            DB_PASSWORD: ${POSTGRES_RESERVATION_PASSWORD:-reservationpass123}
            ACCOMMODATION_GRPC_URL: trubanb-accommodation-service:50051
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: reservation-service
            NODE_ENV: ${NODE_ENV:-development}
            RABBITMQ_URL: amqp://${RABBITMQ_USER:-guest}:${RABBITMQ_PASSWORD:-guest}@rabbitmq:5672
            PORT: 3000
            RESERVATION_GRPC_PORT: 50052
            CORS_ORIGIN: ${CORS_ORIGIN:-*}
        networks:
            - trubanb-network

    # ============================================================================
    # RATING SERVICE
    # ============================================================================

    # MongoDB for rating-service
    mongodb:
        image: mongo:7-jammy
        restart: always
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-rootpass123}
            MONGO_INITDB_DATABASE: ratingsdb
        ports:
            - "27017:27017"
        volumes:
            - mongodb-data:/data/db
            - ./mongo/mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network

    trubanb-rating-service:
        restart: always
        build:
            context: ${RATING_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${RATING_SERVICE_PORT}:3000"
        depends_on:
            mongodb:
                condition: service_healthy
            jaeger:
                condition: service_healthy
            trubanb-reservation-service:
                condition: service_started
        environment:
            MONGODB_URI: mongodb://ratingservice:${MONGODB_RATING_PASSWORD:-ratingpass123}@mongodb:27017/ratingsdb?authSource=ratingsdb
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: rating-service
            NODE_ENV: ${NODE_ENV:-development}
            RESERVATION_GRPC_URL: trubanb-reservation-service:50052
            PORT: 3000
            CORS_ORIGIN: ${CORS_ORIGIN:-*}
        networks:
            - trubanb-network

    # ============================================================================
    # NOTIFICATION SERVICE
    # ============================================================================

    trubanb-notification-service:
        restart: always
        build:
            context: ${NOTIFICATION_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${NOTIFICATION_SERVICE_PORT}:3000"
        depends_on:
            jaeger:
                condition: service_healthy
        environment:
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: notification-service
            NODE_ENV: ${NODE_ENV:-development}
            PORT: 3000
        networks:
            - trubanb-network

    # ============================================================================
    # FRONTEND
    # ============================================================================

    trubanb-frontend:
        restart: always
        build:
            context: ${FRONTEND_PATH}
            dockerfile: Dockerfile
        ports:
            - "${FRONTEND_PORT}:80"
        environment:
            VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}
        networks:
            - trubanb-network

    # ============================================================================
    # OBSERVABILITY - TRACING
    # ============================================================================

    jaeger:
        image: jaegertracing/all-in-one:latest
        restart: always
        ports:
            - "16686:16686"     # Jaeger UI
            - "4318:4318"       # OTLP HTTP receiver
        environment:
            - COLLECTOR_OTLP_ENABLED=true
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network

    # ============================================================================
    # OBSERVABILITY - METRICS
    # ============================================================================

    prometheus:
        image: prom/prometheus:latest
        container_name: prometheus
        restart: always
        ports:
            - "9090:9090"
        volumes:
            - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - prometheus-data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--web.enable-lifecycle'
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network

    node-exporter:
        image: prom/node-exporter:latest
        container_name: node-exporter
        restart: always
        ports:
            - "9100:9100"
        volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro
        command:
            - '--path.procfs=/host/proc'
            - '--path.sysfs=/host/sys'
            - '--path.rootfs=/rootfs'
            - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'
        networks:
            - trubanb-network

    cadvisor:
        image: gcr.io/cadvisor/cadvisor:latest
        container_name: cadvisor
        restart: always
        ports:
            - "8080:8080"
        volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:ro
            - /sys:/sys:ro
            - /var/lib/docker/:/var/lib/docker:ro
            - /dev/disk/:/dev/disk:ro
        privileged: true
        devices:
            - /dev/kmsg
        networks:
            - trubanb-network

    # ============================================================================
    # OBSERVABILITY - LOGGING
    # ============================================================================

    loki:
        image: grafana/loki:3.0.0
        restart: always
        ports:
            - "3100:3100"
        volumes:
            - ./loki/loki-config.yaml:/etc/loki/local-config.yaml:ro
            - loki-data:/loki
        command: -config.file=/etc/loki/local-config.yaml
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:3100/ready"]
            interval: 10s
            timeout: 5s
            retries: 5
        networks:
            - trubanb-network

    alloy:
        image: grafana/alloy:latest
        restart: always
        ports:
            - "12345:12345"     # Alloy UI
        volumes:
            - ./alloy/alloy-config.alloy:/etc/alloy/config.alloy:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
        command: run --server.http.listen-addr=0.0.0.0:12345 /etc/alloy/config.alloy
        depends_on:
            loki:
                condition: service_healthy
        user: root
        networks:
            - trubanb-network

    grafana:
        image: grafana/grafana:11.0.0
        restart: always
        ports:
            - "3000:3000"
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
            - GF_USERS_ALLOW_SIGN_UP=false
        volumes:
            - grafana-data:/var/lib/grafana
            - ./grafana/provisioning:/etc/grafana/provisioning:ro
        depends_on:
            loki:
                condition: service_healthy
        networks:
            - trubanb-network

volumes:
    postgres-user-data:
    postgres-accommodation-data:
    postgres-reservation-data:
    mongodb-data:
    minio-data:
    loki-data:
    grafana-data:
    prometheus-data:
    rabbitmq-data:
