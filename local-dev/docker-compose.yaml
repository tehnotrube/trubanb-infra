services:
    # ============================================================================
    # USER SERVICE
    # ============================================================================

    # PostgreSQL for user-service
    postgresql-user:
        image: postgres:16-alpine
        restart: always
        environment:
            POSTGRES_DB: userdb
            POSTGRES_USER: userservice
            POSTGRES_PASSWORD: ${POSTGRES_USER_PASSWORD:-userpass123}
        ports:
            - "5432:5432"
        volumes:
            - postgres-user-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U userservice -d userdb"]
            interval: 10s
            timeout: 5s
            retries: 5

    trubanb-user-service:
        restart: always
        build:
            context: ${USER_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${USER_SERVICE_PORT}:3000"
        depends_on:
            postgresql-user:
                condition: service_healthy
            jaeger:
                condition: service_healthy
        environment:
            DB_HOST: postgresql-user
            DB_PORT: 5432
            DB_NAME: userdb
            DB_USER: userservice
            DB_PASSWORD: ${POSTGRES_USER_PASSWORD:-userpass123}
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: user-service

    # ============================================================================
    # ACCOMMODATION SERVICE
    # ============================================================================

    # PostgreSQL for accommodation-service
    postgresql-accommodation:
        image: postgres:16-alpine
        restart: always
        environment:
            POSTGRES_DB: accommodationdb
            POSTGRES_USER: accommodationservice
            POSTGRES_PASSWORD: ${POSTGRES_ACCOMMODATION_PASSWORD:-accommodationpass123}
        ports:
            - "5433:5432"
        volumes:
            - postgres-accommodation-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U accommodationservice -d accommodationdb"]
            interval: 10s
            timeout: 5s
            retries: 5

    trubanb-accomodation-service:
        restart: always
        build:
            context: ${ACCOMODATION_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${ACCOMODATION_SERVICE_PORT}:3000"
        depends_on:
            postgresql-accommodation:
                condition: service_healthy
            jaeger:
                condition: service_healthy
        environment:
            DB_HOST: postgresql-accommodation
            DB_PORT: 5432
            DB_NAME: accommodationdb
            DB_USER: accommodationservice
            DB_PASSWORD: ${POSTGRES_ACCOMMODATION_PASSWORD:-accommodationpass123}
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: accommodation-service

    # ============================================================================
    # RESERVATION SERVICE
    # ============================================================================

    # PostgreSQL for reservation-service
    postgresql-reservation:
        image: postgres:16-alpine
        restart: always
        environment:
            POSTGRES_DB: reservationdb
            POSTGRES_USER: reservationservice
            POSTGRES_PASSWORD: ${POSTGRES_RESERVATION_PASSWORD:-reservationpass123}
        ports:
            - "5434:5432"
        volumes:
            - postgres-reservation-data:/var/lib/postgresql/data
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U reservationservice -d reservationdb"]
            interval: 10s
            timeout: 5s
            retries: 5

    trubanb-reservation-service:
        restart: always
        build:
            context: ${RESERVATION_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${RESERVATION_SERVICE_PORT}:3000"
        depends_on:
            postgresql-reservation:
                condition: service_healthy
            jaeger:
                condition: service_healthy
        environment:
            DB_HOST: postgresql-reservation
            DB_PORT: 5432
            DB_NAME: reservationdb
            DB_USER: reservationservice
            DB_PASSWORD: ${POSTGRES_RESERVATION_PASSWORD:-reservationpass123}
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: reservation-service

    # ============================================================================
    # RATING SERVICE
    # ============================================================================

    # MongoDB for rating-service
    mongodb:
        image: mongo:7-jammy
        restart: always
        environment:
            MONGO_INITDB_ROOT_USERNAME: root
            MONGO_INITDB_ROOT_PASSWORD: ${MONGODB_ROOT_PASSWORD:-rootpass123}
            MONGO_INITDB_DATABASE: ratingsdb
        ports:
            - "27017:27017"
        volumes:
            - mongodb-data:/data/db
            - ./mongo-init.js:/docker-entrypoint-initdb.d/mongo-init.js:ro
        healthcheck:
            test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
            interval: 10s
            timeout: 5s
            retries: 5

    trubanb-rating-service:
        restart: always
        build:
            context: ${RATING_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${RATING_SERVICE_PORT}:3000"
        depends_on:
            mongodb:
                condition: service_healthy
            jaeger:
                condition: service_healthy
        environment:
            MONGODB_URI: mongodb://ratingservice:${MONGODB_RATING_PASSWORD:-ratingpass123}@mongodb:27017/ratingsdb?authSource=ratingsdb
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: rating-service

    # ============================================================================
    # NOTIFICATION SERVICE
    # ============================================================================

    trubanb-notification-service:
        restart: always
        build:
            context: ${NOTIFICATION_SERVICE_PATH}
            dockerfile: Dockerfile
        ports:
            - "${NOTIFICATION_SERVICE_PORT}:3000"
        depends_on:
            jaeger:
                condition: service_healthy
        environment:
            OTEL_EXPORTER_OTLP_ENDPOINT: http://jaeger:4318
            OTEL_SERVICE_NAME: notification-service

    # ============================================================================
    # FRONTEND
    # ============================================================================

    trubanb-frontend:
        restart: always
        build:
            context: ${FRONTEND_PATH}
            dockerfile: Dockerfile
        ports:
            - "${FRONTEND_PORT}:80"

    # ============================================================================
    # OBSERVABILITY - TRACING
    # ============================================================================

    jaeger:
        image: jaegertracing/all-in-one:latest
        restart: always
        ports:
            - "16686:16686"     # Jaeger UI
            - "4318:4318"       # OTLP HTTP receiver
        environment:
            - COLLECTOR_OTLP_ENABLED=true
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:14269/"]
            interval: 10s
            timeout: 5s
            retries: 5

    # ============================================================================
    # OBSERVABILITY - METRICS
    # ============================================================================

    prometheus:
        image: prom/prometheus:latest
        container_name: prometheus
        restart: always
        ports:
            - "9090:9090"
        volumes:
            - ../prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
            - prometheus-data:/prometheus
        command:
            - '--config.file=/etc/prometheus/prometheus.yml'
            - '--storage.tsdb.path=/prometheus'
            - '--web.console.libraries=/etc/prometheus/console_libraries'
            - '--web.console.templates=/etc/prometheus/consoles'
            - '--web.enable-lifecycle'
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
            interval: 10s
            timeout: 5s
            retries: 5

    node-exporter:
        image: prom/node-exporter:latest
        container_name: node-exporter
        restart: always
        ports:
            - "9100:9100"
        volumes:
            - /proc:/host/proc:ro
            - /sys:/host/sys:ro
            - /:/rootfs:ro
        command:
            - '--path.procfs=/host/proc'
            - '--path.sysfs=/host/sys'
            - '--path.rootfs=/rootfs'
            - '--collector.filesystem.mount-points-exclude=^/(sys|proc|dev|host|etc)($$|/)'

    cadvisor:
        image: gcr.io/cadvisor/cadvisor:latest
        container_name: cadvisor
        restart: always
        ports:
            - "8080:8080"
        volumes:
            - /:/rootfs:ro
            - /var/run:/var/run:ro
            - /sys:/sys:ro
            - /var/lib/docker/:/var/lib/docker:ro
            - /dev/disk/:/dev/disk:ro
        privileged: true
        devices:
            - /dev/kmsg

    # ============================================================================
    # OBSERVABILITY - LOGGING
    # ============================================================================

    loki:
        image: grafana/loki:3.0.0
        restart: always
        ports:
            - "3100:3100"
        volumes:
            - ../loki/loki-config.yaml:/etc/loki/local-config.yaml:ro
            - loki-data:/loki
        command: -config.file=/etc/loki/local-config.yaml
        healthcheck:
            test: ["CMD", "wget", "--spider", "-q", "http://localhost:3100/ready"]
            interval: 10s
            timeout: 5s
            retries: 5

    alloy:
        image: grafana/alloy:latest
        restart: always
        ports:
            - "12345:12345"     # Alloy UI
        volumes:
            - ../alloy/alloy-config.alloy:/etc/alloy/config.alloy:ro
            - /var/run/docker.sock:/var/run/docker.sock:ro
        command: run --server.http.listen-addr=0.0.0.0:12345 /etc/alloy/config.alloy
        depends_on:
            loki:
                condition: service_healthy
        user: root

    grafana:
        image: grafana/grafana:11.0.0
        restart: always
        ports:
            - "3000:3000"
        environment:
            - GF_SECURITY_ADMIN_USER=admin
            - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
            - GF_USERS_ALLOW_SIGN_UP=false
        volumes:
            - grafana-data:/var/lib/grafana
            - ../grafana/provisioning:/etc/grafana/provisioning:ro
        depends_on:
            loki:
                condition: service_healthy

volumes:
    postgres-user-data:
    postgres-accommodation-data:
    postgres-reservation-data:
    mongodb-data:
    loki-data:
    grafana-data:
    prometheus-data:
