# ============================================================================
# TRUBANB UMBRELLA CHART - VALUES
# ============================================================================

# Kong API Gateway Configuration
kong:
  enabled: true

  ingressController:
    enabled: true
    installCRDs: false

  proxy:
    type: LoadBalancer

  env:
    database: "off"  # DB-less mode

  # Admin API (for management)
  admin:
    enabled: true
    type: ClusterIP
    http:
      enabled: true

  # JWT Authentication Configuration (shared across all services)
  jwt:
    enabled: false  # Enable in environment-specific values files
    secret: ""  # Override in environment values (local/dev/prod)
    issuerKey: "trubanb-service"  # JWT issuer key
    consumerUsername: "trubanb-jwt-issuer"  # Kong consumer username
    maximumExpiration: 86400  # 24 hours in seconds

# ============================================================================
# POSTGRESQL DATABASES
# ============================================================================

# PostgreSQL for user-service
postgresql-user:
  enabled: true
  
  auth:
    username: userservice
    password: ""  # Set via secret or --set flag
    database: userdb
    existingSecret: ""  # Optional: reference existing secret
  
  primary:
    persistence:
      enabled: true
      size: 2Gi
      storageClass: ""  # Use default storage class
    
    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi

# PostgreSQL for accommodation-service
postgresql-accommodation:
  enabled: true

  auth:
    username: accommodationservice
    password: ""  # Set via secret or --set flag
    database: accommodationdb
    existingSecret: ""  # Optional: reference existing secret

  primary:
    persistence:
      enabled: true
      size: 5Gi  # Larger for accommodation data
      storageClass: ""  # Use default storage class

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi

# PostgreSQL for reservation-service
postgresql-reservation:
  enabled: true

  auth:
    username: reservationservice
    password: ""  # Set via secret or --set flag
    database: reservationdb
    existingSecret: ""  # Optional: reference existing secret

  primary:
    persistence:
      enabled: true
      size: 3Gi
      storageClass: ""  # Use default storage class

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi

# ============================================================================
# MONGODB DATABASE
# ============================================================================

mongodb:
  enabled: true
  
  auth:
    enabled: true
    rootPassword: ""  # Set via secret or --set flag
    username: ratingservice
    password: ""  # Set via secret or --set flag
    database: ratingsdb
    existingSecret: ""  # Optional: reference existing secret
  
  architecture: standalone  # Use 'replicaset' for production
  
  persistence:
    enabled: true
    size: 3Gi
    storageClass: ""  # Use default storage class
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi
  
  metrics:
    enabled: false  # Enable for monitoring

# ============================================================================
# MINIO - Object Storage
# ============================================================================

minio:
  enabled: false  # Enable in environment-specific values

  # Official MinIO chart configuration
  rootUser: admin
  rootPassword: ""  # Set via secret or --set flag

  replicas: 1  # Standalone mode

  persistence:
    enabled: true
    size: 10Gi
    storageClass: ""  # Use default storage class

  buckets:
    - name: accommodations
      policy: public
      purge: false

  resources:
    requests:
      cpu: 250m
      memory: 256Mi

# ============================================================================
# MICROSERVICES
# ============================================================================

# User Service
user-service:
  enabled: true
  replicaCount: 2
  
  image:
    repository: ghcr.io/tehnotrube/user-service
    tag: "v1.0.0"
    pullPolicy: IfNotPresent
  
  database:
    # These will auto-generate to match postgresql-user
    host: ""  # Defaults to {{ .Release.Name }}-postgresql-user
    port: "5432"
    name: "userdb"
    existingSecret: ""  # Defaults to {{ .Release.Name }}-postgresql-user
  
  service:
    port: 8080
  
  ingress:
    enabled: true
    className: kong
    annotations:
      konghq.com/strip-path: "false"
      konghq.com/preserve-host: "true"
    hosts:
      - host: api.trubanb.local
        paths:
          - path: /api/users
            pathType: Prefix
  
  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# Accommodation Service
accommodation-service:
  enabled: true
  replicaCount: 2

  image:
    repository: ghcr.io/tehnotrube/accommodation-service
    tag: "v1.0.0"
    pullPolicy: IfNotPresent

  database:
    # These will auto-generate to match postgresql-accommodation
    host: ""  # Defaults to {{ .Release.Name }}-postgresql-accommodation
    port: "5432"
    name: "accommodationdb"
    existingSecret: ""  # Defaults to {{ .Release.Name }}-postgresql-accommodation

  service:
    port: 8080

  ingress:
    enabled: true
    className: kong
    annotations:
      konghq.com/strip-path: "false"
      konghq.com/preserve-host: "true"
    hosts:
      - host: api.trubanb.local
        paths:
          - path: /api/accommodations
            pathType: Prefix

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# Reservation Service
reservation-service:
  enabled: true
  replicaCount: 2

  image:
    repository: ghcr.io/tehnotrube/reservation-service
    tag: "v1.0.0"
    pullPolicy: IfNotPresent

  database:
    # These will auto-generate to match postgresql-reservation
    host: ""  # Defaults to {{ .Release.Name }}-postgresql-reservation
    port: "5432"
    name: "reservationdb"
    existingSecret: ""  # Defaults to {{ .Release.Name }}-postgresql-reservation

  service:
    port: 8080

  ingress:
    enabled: true
    className: kong
    annotations:
      konghq.com/strip-path: "false"
      konghq.com/preserve-host: "true"
    hosts:
      - host: api.trubanb.local
        paths:
          - path: /api/reservations
            pathType: Prefix

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# Rating Service
rating-service:
  enabled: true
  replicaCount: 2

  image:
    repository: ghcr.io/tehnotrube/rating-service
    tag: "v1.0.0"
    pullPolicy: IfNotPresent

  mongodb:
    # These will auto-generate to match mongodb
    host: ""  # Defaults to {{ .Release.Name }}-mongodb
    port: "27017"
    database: "ratingsdb"
    existingSecret: ""  # Defaults to {{ .Release.Name }}-mongodb

  service:
    port: 8080

  ingress:
    enabled: true
    className: kong
    annotations:
      konghq.com/strip-path: "false"
      konghq.com/preserve-host: "true"
    hosts:
      - host: api.trubanb.local
        paths:
          - path: /api/ratings
            pathType: Prefix

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

# Notification Service
notification-service:
  enabled: true
  replicaCount: 2

  image:
    repository: ghcr.io/tehnotrube/notification-service
    tag: "v1.0.0"
    pullPolicy: IfNotPresent

  service:
    port: 8080

  ingress:
    enabled: true
    className: kong
    annotations:
      konghq.com/strip-path: "false"
      konghq.com/preserve-host: "true"
    hosts:
      - host: api.trubanb.local
        paths:
          - path: /api/notifications
            pathType: Prefix

  resources:
    limits:
      cpu: 500m
      memory: 512Mi
    requests:
      cpu: 250m
      memory: 256Mi

  # Additional environment variables for notification service
  extraEnv: []
  # - name: SMTP_HOST
  #   value: "smtp.example.com"
  # - name: SMTP_PORT
  #   value: "587"

# ============================================================================
# OBSERVABILITY STACK
# ============================================================================

# Prometheus Stack (Prometheus, Grafana, Alertmanager, node-exporter)
kube-prometheus-stack:
  enabled: false  # Enable in environment-specific values

  # Grafana configuration
  grafana:
    enabled: true
    adminPassword: ""  # Set in environment values
    persistence:
      enabled: true
      size: 5Gi

    # Datasources provisioning
    additionalDataSources:
      - name: Loki
        type: loki
        url: http://{{ .Release.Name }}-loki:3100
        access: proxy
        isDefault: false
      - name: Jaeger
        type: jaeger
        url: http://{{ .Release.Name }}-jaeger-query:16686
        access: proxy
        isDefault: false

    # Dashboard provisioning
    dashboardProviders:
      dashboardproviders.yaml:
        apiVersion: 1
        providers:
          - name: 'default'
            orgId: 1
            folder: ''
            type: file
            disableDeletion: false
            editable: true
            options:
              path: /var/lib/grafana/dashboards/default

  # Prometheus configuration
  prometheus:
    prometheusSpec:
      retention: 15d
      storageSpec:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 10Gi

      # Scrape configs for microservices
      additionalScrapeConfigs:
        - job_name: 'trubanb-services'
          kubernetes_sd_configs:
            - role: pod
          relabel_configs:
            - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
              action: keep
              regex: true
            - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
              action: replace
              target_label: __metrics_path__
              regex: (.+)
            - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
              action: replace
              regex: ([^:]+)(?::\d+)?;(\d+)
              replacement: $1:$2
              target_label: __address__
            - source_labels: [__meta_kubernetes_namespace]
              action: replace
              target_label: kubernetes_namespace
            - source_labels: [__meta_kubernetes_pod_name]
              action: replace
              target_label: kubernetes_pod_name

  # Alertmanager configuration
  alertmanager:
    enabled: true
    alertmanagerSpec:
      storage:
        volumeClaimTemplate:
          spec:
            accessModes: ["ReadWriteOnce"]
            resources:
              requests:
                storage: 2Gi

  # Node exporter for host metrics
  nodeExporter:
    enabled: true

  # Kube-state-metrics for Kubernetes object metrics
  kubeStateMetrics:
    enabled: true

# Loki - Log Aggregation
loki:
  enabled: false  # Enable in environment-specific values

  deploymentMode: SingleBinary

  loki:
    auth_enabled: false

    commonConfig:
      replication_factor: 1

    storage:
      type: filesystem

    schemaConfig:
      configs:
        - from: "2024-01-01"
          store: tsdb
          object_store: filesystem
          schema: v13
          index:
            prefix: loki_index_
            period: 24h

  singleBinary:
    replicas: 1
    persistence:
      enabled: true
      size: 10Gi

  # Disable other deployment modes
  read:
    replicas: 0
  write:
    replicas: 0
  backend:
    replicas: 0

  # Gateway configuration
  gateway:
    enabled: false

# Promtail - Log Collector
promtail:
  enabled: false  # Enable in environment-specific values

  config:
    clients:
      - url: http://{{ .Release.Name }}-loki:3100/loki/api/v1/push

    snippets:
      pipelineStages:
        - cri: {}
        - multiline:
            firstline: '^\d{4}-\d{2}-\d{2}|\[[\d-]+\s[\d:,]+\]|^{'
            max_wait_time: 3s
        - json:
            expressions:
              level: level
              message: message
              service: service
        - labels:
            level:
            service:

# Jaeger - Distributed Tracing
jaeger:
  enabled: false  # Enable in environment-specific values

  provisionDataStore:
    cassandra: false
    elasticsearch: false
    kafka: false

  allInOne:
    enabled: true
    image:
      registry: docker.io
      repository: jaegertracing/all-in-one
      tag: latest
      pullPolicy: IfNotPresent

    resources:
      limits:
        cpu: 500m
        memory: 512Mi
      requests:
        cpu: 250m
        memory: 256Mi

  storage:
    type: memory  # Use 'elasticsearch' or 'cassandra' for production

  collector:
    enabled: false  # Using all-in-one

  query:
    enabled: false  # Using all-in-one

  agent:
    enabled: false  # Using all-in-one

# ============================================================================
# OBSERVABILITY - OTEL Configuration (shared across services)
# ============================================================================
observability:
  # OpenTelemetry configuration for microservices
  otel:
    enabled: false  # Enable in environment-specific values
    # Jaeger OTLP endpoint (services will use this)
    otlpEndpoint: ""  # Set to http://{{ .Release.Name }}-jaeger-collector:4318 in env values
    serviceName: ""   # Set per service
