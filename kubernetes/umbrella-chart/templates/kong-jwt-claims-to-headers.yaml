{{- if .Values.kong.jwt.enabled -}}
apiVersion: configuration.konghq.com/v1
kind: KongClusterPlugin
metadata:
  name: {{ .Release.Name }}-jwt-claims-to-headers
  labels:
    app.kubernetes.io/name: {{ .Chart.Name }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
  annotations:
    kubernetes.io/ingress.class: kong
plugin: post-function
config:
  access:
    - |
      local function base64_url_decode(str)
        local remainder = #str % 4
        if remainder > 0 then
          str = str .. string.rep('=', 4 - remainder)
        end
        str = str:gsub('-', '+'):gsub('_', '/')
        return (str:gsub('.', function(c)
          return string.char(tonumber(c:byte() * 16777216 / 16777216))
        end))
      end

      local auth_header = kong.request.get_header("Authorization")
      if auth_header and auth_header:match("^Bearer%s+(.+)") then
        local jwt_token = auth_header:match("^Bearer%s+(.+)")
        local parts = {}
        for part in jwt_token:gmatch("[^%.]+") do
          table.insert(parts, part)
        end

        if #parts == 3 then
          -- Decode payload (second part)
          local decoded = ngx.decode_base64(parts[2])
          if decoded then
            -- Extract claims using pattern matching (avoid JSON library)
            local sub = decoded:match('"sub"%s*:%s*"([^"]+)"')
            local email = decoded:match('"email"%s*:%s*"([^"]+)"')
            local role = decoded:match('"role"%s*:%s*"([^"]+)"')

            if sub then
              kong.service.request.set_header("X-User-Id", sub)
            end
            if email then
              kong.service.request.set_header("X-User-Email", email)
            end
            if role then
              kong.service.request.set_header("X-User-Role", role)
            end
            kong.log.info("JWT claims extracted: sub=", sub, " email=", email, " role=", role)
          end
        end
      end
{{- end }}
